# DDAT: Diffusion Policies Enforcing Dynamically Admissible Robot Trajectories

**相关性评分**: 8.0/10

**排名**: #1


---


## 基本信息

- **arXiv ID**: [2502.15043v2](https://arxiv.org/abs/2502.15043v2)
- **发布时间**: 2025-02-20T21:00:21Z
- **相关性评分**: 8.0/10
- **是否相关**: 是

## 作者

Jean-Baptiste Bouvier, Kanghyun Ryu, Kartik Nagpal, Qiayuan Liao, Koushil Sreenath, Negar Mehr

## 关键词

Robot control, quadruped robot locomotion, mujoco, local observational information

## 一句话总结

DDAT提出一种基于扩散模型的机器人轨迹生成方法，通过动态可容许性约束确保轨迹可行性，并在四足机器人MuJoCo环境中验证。

## 摘要

Diffusion models excel at creating images and videos thanks to their multimodal generative capabilities. These same capabilities have made diffusion models increasingly popular in robotics research, where they are used for generating robot motion. However, the stochastic nature of diffusion models is fundamentally at odds with the precise dynamical equations describing the feasible motion of robots. Hence, generating dynamically admissible robot trajectories is a challenge for diffusion models. To alleviate this issue, we introduce DDAT: Diffusion policies for Dynamically Admissible Trajectories to generate provably admissible trajectories of black-box robotic systems using diffusion models. A sequence of states is a dynamically admissible trajectory if each state of the sequence belongs to the reachable set of its predecessor by the robot's equations of motion. To generate such trajectories, our diffusion policies project their predictions onto a dynamically admissible manifold during both training and inference to align the objective of the denoiser neural network with the dynamical admissibility constraint. The auto-regressive nature of these projections along with the black-box nature of robot dynamics render these projections immensely challenging. We thus enforce admissibility by iteratively sampling a polytopic under-approximation of the reachable set of a state onto which we project its predicted successor, before iterating this process with the projected successor. By producing accurate trajectories, this projection eliminates the need for diffusion models to continually replan, enabling one-shot long-horizon trajectory planning. We demonstrate that our framework generates higher quality dynamically admissible robot trajectories through extensive simulations on a quadcopter and various MuJoCo environments, along with real-world experiments on a Unitree GO1 and GO2.

## 详细分析

## DDAT论文详细摘要

### 1. 研究背景和动机
扩散模型凭借其强大的多模态生成能力，在图像和视频生成领域取得了卓越成就。近年来，这些能力也使其在机器人运动规划领域受到广泛关注。然而，扩散模型的**随机生成特性**与描述机器人**精确动力学方程**之间存在根本性矛盾。机器人可行的运动轨迹必须满足动态可容许性约束，即每个后续状态都必须位于其前驱状态的可达集内。由于可达集维度远低于状态空间，且依赖于当前状态，直接从数据中学习生成此类轨迹极具挑战性。这导致现有的扩散规划器通常为欠驱动机器人生成不可行的轨迹，限制了其在复杂机器人系统上的应用。

### 2. 核心方法和技术创新
本文提出了 **DDAT（用于动态可容许轨迹的扩散策略）** 框架，旨在为黑盒机器人系统生成动态可容许的轨迹。其核心创新在于：

- **时序轨迹投影器**：在扩散模型的**训练和推理阶段**，将模型预测的状态序列投影到一个动态可容许流形上。这通过迭代地对每个预测的下一状态进行投影来实现，使其落入当前状态可达集的一个**多面体下近似**中。
- **多种投影方案**：针对不同场景，提出了多种投影器，包括基础投影、引入参考轨迹的引导投影、以及利用动作预测来缩小搜索空间或直接生成可行状态的投影器。
- **投影课程学习**：设计了一种课程学习策略，仅在噪声水平足够低时才进行投影，以避免在训练初期因无意义的随机状态投影而破坏学习过程，并平滑地引入投影损失。

### 3. 主要实验结果
研究在多个仿真环境（四旋翼无人机、Gym Hopper/Walker/HalfCheetah、Unitree GO1/GO2）和真实硬件（Unitree GO1和GO2四足机器人）上进行了验证：
- **动态可容许性**：DDAT生成的轨迹在状态级和累积可容许性误差上均比基线扩散模型低数个数量级，部分模型能生成**严格可容许**的轨迹。
- **轨迹质量**：与在整个推理过程早期就进行投影或在推理结束后才投影的方法相比，DDAT采用的渐进式投影课程能生成质量更高、成功率更高的轨迹。
- **硬件部署**：在Unitree GO2上的开环硬件实验表明，DDAT的成功率是未使用投影的基线扩散模型的两倍以上，证明了其生成平滑、可行轨迹的能力对于实际部署至关重要。

### 4. 研究意义和价值
DDAT首次系统性地解决了扩散模型在**黑盒、欠驱动**机器人系统上生成**长时域、一次性、动态可容许轨迹**的难题。其贡献在于：
- **理论价值**：为在生成模型中严格嵌入序列化、自回归的动力学约束提供了新颖的算法框架。
- **实践价值**：生成的轨迹具备动态可行性，**无需持续重规划**，降低了计算开销，为实现高效、可靠的开环或长时域规划铺平了道路。
- **开源贡献**：公开了代码，推动了机器人学习与生成模型交叉领域的发展。

## 问答对

### 问题 1

**Q**: 这篇论文的核心创新点是什么，他想解决什么问题，怎么解决的？

**A**: ## DDAT：用于生成动态可行机器人轨迹的扩散策略

### **核心问题**
这篇论文旨在解决**扩散模型在机器人运动规划中的动态可行性问题**。扩散模型因其强大的多模态生成能力，在图像和视频生成领域表现出色，但在机器人轨迹生成中，其**随机性本质**与描述机器人可行运动的**精确动力学方程**存在根本性冲突。这导致扩散模型生成的轨迹序列（状态序列）往往不满足机器人的动力学约束，即不是“动态可行的”。

### **核心创新点**
论文提出了 **DDAT** 框架，其核心创新在于将**动态可行性约束**作为“硬约束”整合到扩散模型的训练和推理全过程中，而非事后处理或软性鼓励。具体创新点包括：

1.  **时序轨迹投影器**：设计了一个能够在训练和推理期间，将扩散模型预测的状态序列**实时投影**到动态可行流形上的机制。这确保了最终输出的轨迹严格满足动力学。
2.  **针对黑盒系统的可达集近似**：针对机器人动力学是“黑盒”（仅有模拟器，无解析式）的实际情况，提出使用**动作空间顶点**通过模拟器前向推演，构建当前状态可达集的**多面体下近似**，作为投影的目标域。
3.  **投影课程学习**：为了避免在噪声水平过高（预测近乎随机）时进行无意义的投影干扰训练，设计了一个**基于噪声水平的投影课程**。仅在噪声低于一定阈值时，才以一定概率执行投影，平滑地将约束引入学习过程。
4.  **多种投影器设计**：论文系统性地提出并比较了四种投影方案，适应不同场景：
    - **基础投影**：贪婪地将每个预测状态投影到当前状态的可达集上。
    - **参考轨迹投影**：在投影时不仅考虑接近预测，也考虑接近一个参考轨迹（如上一次去噪结果），以减少累积误差和轨迹发散。
    - **基于动作预测的投影**：利用扩散模型同时预测状态和动作的优势，以预测动作为中心收缩搜索空间，进行更精确的投影。
    - **状态-动作反馈投影**：使用一个小型神经网络，根据状态预测误差对预测动作进行反馈校正，再执行动力学前向计算，直接得到可行状态。

### **解决方案（技术路径）**
1.  **问题定义**：将动态可行性定义为轨迹中每个后继状态都必须位于其前驱状态的**可达集**内。
2.  **构建投影目标**：对于给定状态 `s_t`，对其动作空间 `𝒜` 的顶点集 `{v_i}` 应用黑盒动力学 `f`，得到一组后继状态 `{f(s_t, v_i)}`。这些后继状态的**凸包** `𝒞(s_t)` 构成了真实可达集的一个**凸下近似**。
3.  **整合到扩散流程**：
    - **训练**：在每次训练迭代中，对加噪的真实轨迹进行去噪得到预测轨迹 `τ̃`。如果当前噪声水平 `σ` 足够低（根据课程），则对 `τ̃` 应用投影器 `𝒫_σ`，得到可行轨迹 `τ̂`。计算 `τ̂` 与原始干净轨迹 `τ` 的损失，用于更新扩散去噪网络 `D_θ`。这使得网络学会预测**易于被投影为可行**的轨迹。
    - **推理**：从随机噪声开始，在每一步去噪迭代后，立即对中间结果进行相同的投影操作。经过 `N` 步后，直接得到一个**动态可行的、无噪声的轨迹**。
4.  **实现与验证**：
    - 使用**扩散Transformer**作为骨干网络。
    - 在多个欠驱动机器人环境（Hopper, Walker2D, HalfCheetah, 四旋翼，Unitree GO1/GO2）上进行仿真和**实物实验**。
    - 使用**状态态容许误差** 和**累积容许误差** 量化轨迹的可行性。
    - 结果表明，DDAT 能生成**高质量、动态可行的长时域轨迹**，实现了**一次性规划**，无需像传统方法那样频繁重规划，并在实物机器人上成功进行了开环部署。

### **实际价值**
- **理论价值**：首次系统性地解决了扩散模型在**黑盒、欠驱动**机器人系统上的动态可行性约束强制执行问题，弥合了生成模型与经典控制之间的鸿沟。
- **应用价值**：
    - 实现了**开环、长时域、高质量的轨迹生成**，降低了在线计算负担。
    - 为在**仿真到实物迁移**中安全、可靠地使用扩散模型提供了框架。
    - 代码开源，促进了相关领域的研究。
- **工程价值**：提出的投影课程、多种投影器设计等具体技术，为后续研究如何将复杂约束嵌入生成模型提供了重要参考和实用工具。


### 问题 2

**Q**: 请用一段话总结这篇论文，明确说明：论文试图解决的核心问题；提出的主要方法或框架；最终取得的主要效果或结论。要求语言简洁、信息密度高，不要复述摘要原文。

**A**: ## 论文总结

这篇论文旨在解决扩散模型在机器人运动规划中生成**动态可行轨迹**的核心难题。扩散模型固有的随机性与机器人精确的动力学方程相冲突，导致其生成的轨迹序列往往不满足动力学约束，尤其对于欠驱动系统。

为此，论文提出了 **DDAT** 框架。其核心创新在于设计了一系列**时序投影器**，在扩散模型的训练和推理过程中，将神经网络预测的状态序列迭代地投影到一个由机器人黑盒动力学模型构建的**可达集多面体下近似**上，从而强制轨迹满足动力学可行性。该方法的关键在于处理了投影的自回归性质和黑盒动力学的挑战。

实验表明，DDAT 能够为多种机器人（如四足机器人和四旋翼）生成高质量、动态可行的开环轨迹，显著提升了轨迹的可行性（将误差降低数个数量级）和任务完成质量（如生存率和奖励），并在真实硬件上验证了其有效性，实现了无需持续重规划的一次性长时程轨迹生成。


### 问题 3

**Q**: 这篇论文相对于已有工作有哪些明确的创新点？请逐条列出，并对每一条说明：相比以往方法改进或不同之处在哪里，以及该创新解决了什么具体问题或带来了什么优势。

**A**: ## DDAT论文创新点分析

这篇论文针对扩散模型在机器人轨迹规划中难以保证**动态可行性**的核心挑战，提出了一套系统性的解决方案。其创新点明确且具有递进关系，具体如下：

### 1. **首次为黑盒动力学系统生成动态可行轨迹的扩散策略框架**
   - **改进之处**：以往工作（如[31, 36]）仅关注线性或全驱动系统，或通过重规划（如[55]）、后处理投影（如[22]）等间接方式处理可行性问题，无法为通用的、动力学位数不足（underactuated）的黑盒机器人系统**保证**轨迹可行性。
   - **解决的问题与优势**：DDAT首次将扩散模型的生成能力与动态可行性约束**硬性结合**，为四足机器人、四旋翼等复杂黑盒系统生成**一次性、长时域、开环即可行**的轨迹。这解决了扩散模型随机采样与确定性动力学方程之间的根本矛盾，避免了因轨迹不可行而需要频繁重规划的计算浪费。

### 2. **提出并系统比较了多种时序投影器，以在训练和推理中强制执行动态可行性**
   - **改进之处**：现有方法多在推理后单次投影（易发散）或仅在推理中投影。DDAT创新性地提出了一个投影器家族（`𝒫`, `𝒫ref`, `𝒫A`, `𝒫SA`），并**在训练和推理全过程中集成**这些投影，使去噪网络的目标与动态可行性约束对齐。
     - **`𝒫ref`**：引入参考轨迹引导投影，解决了贪婪投影（Algorithm 1）导致的误差累积和轨迹发散问题（如图2所示）。
     - **`𝒫SA`**：结合状态和动作预测，利用一个小型反馈网络 `π_θ` 校正动作，比单纯使用动作预测（`𝒫A`）或状态投影精度更高。
   - **解决的问题与优势**：解决了在黑盒、非凸可达集下进行精确时序投影的挑战。通过将投影融入训练，模型学会了生成更接近可行流形的轨迹，从而在推理时只需较小的投影修正，提高了生成轨迹的质量和可行性。

### 3. **设计了基于可达集多面体下近似的可行流形投影算法**
   - **改进之处**：针对黑盒动力学无法获得可达集闭式解的问题，论文提出利用动作空间顶点（如超立方体的`2^m`个顶点）通过仿真生成下一状态顶点，并取其凸包作为可达集的**多面体下近似**（`𝒞(s_t)`）。投影在该凸包上进行。
   - **解决的问题与优势**：将复杂的、依赖于状态的流形投影问题，转化为可处理的凸优化问题（使用`cvxpylayers`实现可微化）。尽管对于接触动力学系统，真实可达集可能非凸，但实验表明该近似在实践中非常有效，为黑盒系统提供了可行的投影基础。

### 4. **引入了渐进式投影课程，平衡训练稳定性与约束满足**
   - **改进之处**：不同于在推理每一步都投影[10]或仅在最后投影[22]，DDAT设计了一个依赖于噪声水平`σ`的投影概率课程（公式16）。在高噪声（`σ > σ_max`）时不投影，在低噪声（`σ < σ_min`）时总是投影，在中间过渡区以线性概率投影。
   - **解决的问题与优势**：避免了在训练早期对高度随机的轨迹进行无意义的投影，防止训练损失剧增和训练不稳定。同时，确保了在推理后期（低噪声、轨迹已具雏形）进行精确投影，从而生成高质量且可行的轨迹。实验证明（表II，图5a），过早投影（“pre”）会损害轨迹质量。

### 5. **通过系统实验验证了“状态-动作联合预测”模态的综合优势**
   - **改进之处**：论文对三种扩散预测模态进行了全面比较：仅状态（S）、仅动作（A）、状态-动作联合（SA）。以往工作各有侧重，缺乏统一评估。
   - **解决的问题与优势**：实验表明（表III，IV）：
     - **纯状态模型（S）**：即使配合投影，在复杂系统（如Walker）上可行性仍受限。
     - **纯动作模型（A）**：虽天然可行，但动作序列波动大、难预测，导致规划质量不稳定（在GO1表现好，在GO2表现差）。
     - **状态-动作联合模型（SA）**：**取得了最佳平衡**。它结合了状态预测的平滑性和动作信息对可行性的直接约束，配合`𝒫SA`投影器，能在保证动态可行性的同时，生成高质量、高性能的轨迹。

### 总结：核心创新价值
DDAT的核心创新在于**系统性**地解决了扩散模型在机器人规划中的动态可行性问题。它不是单一技术的改进，而是构建了一个包含**可行性理论定义、多种可微投影器、训练-推理协同课程、以及完整评估体系**的框架。其最大实际价值是实现了**一次性长时域开环规划**，为在计算资源有限的机器人（如四足机器人）上部署强大的扩散规划器提供了可能，并在仿真和实物实验中均验证了优越性。


### 问题 4

**Q**: 论文在实验或评估中最终实现了怎样的效果？请说明使用了哪些数据集和评价指标，与哪些基线方法进行了对比，以及在关键指标上的主要性能提升或结论。如果论文未给出明确的定量结果，也请说明原因。

**A**: ## 论文实验与评估效果总结

该论文通过广泛的仿真和真实硬件实验，系统地评估了所提出的 **DDAT** 框架在生成**动态可行轨迹**方面的有效性。实验表明，DDAT 能够生成高质量、可部署的机器人轨迹，并在多个关键指标上显著优于基线方法。

### 一、 使用的数据集
论文没有使用公开的标准数据集（如 D4RL），而是为每个测试环境**自行创建了可复现的数据集**，以确保动力学模拟的确定性，从而能精确评估轨迹的动态可行性。

- **数据生成方式**：
    - **Hopper, Walker2d, HalfCheetah (MuJoCo)**：使用 PPO 策略生成轨迹。
    - **Quadcopter (自定义仿真器)**：使用模型预测控制生成具有挑战性的避障轨迹。
    - **Unitree GO1/GO2 (MuJoCo)**：使用大规模并行化框架训练 PPO 策略，生成跟随随机速度指令的轨迹。

### 二、 核心评价指标
论文设计了两个核心指标来**量化轨迹的动态可行性**：

1.  **状态级可行性误差 (Statewise Admissibility Error, SAE)**：
    - **定义**：预测的下一个状态 `s̃_{t+1}` 与其**最接近的可行后继状态**之间的欧氏距离。
    - **公式**：`SAE(s_t, s̃_{t+1}) = || s̃_{t+1} - f(s_t, ID(s_t, s̃_{t+1})) ||`
    - **意义**：衡量单步预测偏离动力学可行性的程度。

2.  **累积可行性误差 (Cumulative Admissibility Error, CAE)**：
    - **定义**：整个预测轨迹 `τ̃` 与其通过逆动力学模型迭代投影得到的**最接近可行轨迹**之间的总距离。
    - **意义**：衡量整个长时域轨迹的可行性，包含了误差累积效应。

3.  **任务性能指标**：
    - **生存率 (Survival Rate)**：在开环执行中，机器人未摔倒或未违反状态约束（如离开规定区域）的轨迹比例。
    - **奖励 (Reward)**：使用环境原生的奖励函数（如前进距离、能量效率）评估轨迹质量。

### 三、 对比的基线方法
论文与多种基线方法进行了对比，主要分为以下几类：

1.  **无投影的扩散模型**：
    - **`S`**：仅预测状态序列的扩散模型。
    - **`SA`**：同时预测状态和动作序列的扩散模型。
    - **`A(·|s₀)`**：仅预测动作序列（以初始状态为条件）的扩散模型。

2.  **仅推理时投影的扩散模型**：
    - **`S𝒫_I`**, **`SA𝒫_I`**：在训练时不使用投影，仅在推理时使用论文提出的投影器。

3.  **传统规划方法**：
    - **MPPI (Model Predictive Path Integral)**：作为基于优化的模型预测控制基线。

4.  **训练数据性能**：
    - **`data`**：生成训练数据的闭环策略（RL/MPC）的性能，作为性能上限参考。

### 四、 关键性能结果与结论

#### 1. 动态可行性显著提升 (回答 Q1)
- **结果**：如表 I 所示，应用任何投影方案（即使是仅在推理时使用）都能将 SAE 和 CAE 降低**数个数量级**。
- **例证**：
    - **Hopper**：`S` 模型的 SAE 为 `1.1e-1`，而使用投影的 `S𝒫_I` 模型降至 `8.5e-3`。使用状态-动作投影的 `SA𝒫_σ^{SA}` 模型误差为 **0**（完全可行）。
    - **Walker/HalfCheetah**：类似地，投影模型将误差从 `~0.3` 降至 `~1e-4` 或 `0`。
- **结论**：DDAT 框架成功解决了扩散模型生成轨迹动态不可行的问题。

#### 2. 投影课程策略的影响 (回答 Q2)
- **对比策略**：
    - **`pre`**：推理开始时即投影（高噪声水平）。
    - **`mid`**：在噪声水平降至阈值后逐步投影（论文推荐）。
    - **`post`**：仅在推理完成后投影。
- **结果**（表 II，图 5a, 6）：
    - **可行性**：三种策略对 SAE/CAE 影响差异不大。
    - **轨迹质量**：`pre` 策略严重损害轨迹质量（如 Hopper 生存率仅 `27%`，Quadcopter 无法通过障碍）。`mid` 和 `post` 策略性能接近且更优。
- **结论**：**在低噪声水平（推理中后期）进行投影**能获得最佳性能，过早投影会破坏扩散模型的生成能力。

#### 3. 训练时加入投影的影响 (回答 Q3)
- **结果**（图 5b, 5c, 7）：
    - 在轨迹质量（生存率、奖励）和动态可行性（SAE/CAE）上，**训练时加入投影 (`𝒫_σ`) 与仅推理时投影 (`𝒫_I`) 的模型性能没有显著差异**。
    - 投影本身（而非其加入训练的方式）是提升性能的关键。
- **结论**：训练时加入投影**并非必要**，且可能因增大训练损失而带来不稳定。核心是**在推理时使用正确的投影器**。

#### 4. 最佳预测模态 (回答 Q4)
- **对比模态**：仅状态(`S`)、状态-动作联合(`SA`)、仅动作(`A`)。
- **结果**（表 III, IV, V）：
    - **`SA` 模态综合表现最佳**：模型 `SA𝒫_σ^{SA}` 在多数环境中都能达到接近最优的生存率和奖励，且能保证轨迹可行性。
    - **`S` 模态**：在某些环境（如 Hopper, Quadcopter）表现良好，但缺乏可行性保证，且依赖高性能逆动力学模型进行评估。
    - **`A` 模态**：表现不稳定，在 Hopper 上很差，在其他环境尚可但不如 `SA` 模态鲁棒。
- **结论**：**联合预测状态和动作 (`SA`) 是最佳选择**，它结合了状态预测的规划能力和动作预测的可行性保证。

#### 5. 真实硬件实验验证
- **实验设置**：在 Unitree GO1 和 GO2 四足机器人上开环执行生成的 10 秒行走轨迹。
- **评价指标**：成功到达目标线且不摔倒/不越界的轨迹比例。
- **结果**（表 VI）：
    - **DDAT (`SA𝒫_σ^{SA}`)**：在 30 次试验中成功 **23 次**，失败原因为偏离区域(5次)和摔倒(2次)。
    - **基线扩散模型 (`SA`)**：仅成功 **10 次**，更多失败源于动作导致机器人滑倒或剧烈抖动。
- **结论**：DDAT 生成的**动态可行轨迹显著提升了真实机器人的开环部署成功率和稳定性**，证明了其实际应用价值。

### 五、 主要性能提升总结
1.  **可行性保证**：DDAT 将扩散模型生成的轨迹动态不可行误差降低至接近零，实现了**理论上的可行性保证**（对于 `SA𝒫_σ^{A/SA}` 模型）。
2.  **轨迹质量**：通过合理的投影策略（`mid` 或 `post`），DDAT 在生存率和任务奖励上显著优于无投影的扩散模型，并超越了传统 MPPI 方法。
3.  **长时域规划**：由于生成轨迹本身可行，DDAT 实现了 **一次性长时域规划**，避免了传统扩散规划中因轨迹不可行而需要的高频重规划。
4.  **仿真到实物的转移**：硬件实验成功验证了 DDAT 生成轨迹的**可部署性**和**鲁棒性**。

**局限性与未定量结果说明**：论文明确指出，由于需要精确的逆动力学模型来评估 `S` 模态的可行性，而对于 Unitree 等复杂系统难以获得，因此未给出 Unitree 上 `S` 模态的定量 SAE/CAE 结果。这反过来凸显了 `SA` 和 `A` 模态（其可行性由定义保证）在实际应用中的优势。


## 相关链接

- [arXiv 页面](https://arxiv.org/abs/2502.15043v2)
- [HTML 版本](https://arxiv.org/html/2502.15043v2)
