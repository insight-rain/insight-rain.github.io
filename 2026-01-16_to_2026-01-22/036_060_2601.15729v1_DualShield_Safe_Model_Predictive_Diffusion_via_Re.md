# DualShield: Safe Model Predictive Diffusion via Reachability Analysis for Interactive Autonomous Driving

**相关性评分**: 6.0/10

**排名**: #36


---


## 基本信息

- **arXiv ID**: [2601.15729v1](https://arxiv.org/abs/2601.15729v1)
- **发布时间**: 2026-01-22T07:56:36Z
- **相关性评分**: 6.0/10
- **是否相关**: 是

## 作者

Rui Yang, Lei Zheng, Ruoyu Yao, Jun Ma

## 关键词

Diffusion, Inference Acceleration, fine tune, constrained reinforcement learning, safe reinforcement learning, world model

## 一句话总结

DualShield 是一个基于可达性分析和扩散模型的自动驾驶规划框架，通过主动引导和反应式安全屏蔽确保安全性和动态可行性，适用于不确定交互场景。

## 摘要

Diffusion models have emerged as a powerful approach for multimodal motion planning in autonomous driving. However, their practical deployment is typically hindered by the inherent difficulty in enforcing vehicle dynamics and a critical reliance on accurate predictions of other agents, making them prone to safety issues under uncertain interactions. To address these limitations, we introduce DualShield, a planning and control framework that leverages Hamilton-Jacobi (HJ) reachability value functions in a dual capacity. First, the value functions act as proactive guidance, steering the diffusion denoising process towards safe and dynamically feasible regions. Second, they form a reactive safety shield using control barrier-value functions (CBVFs) to modify the executed actions and ensure safety. This dual mechanism preserves the rich exploration capabilities of diffusion models while providing principled safety assurance under uncertain and even adversarial interactions. Simulations in challenging unprotected U-turn scenarios demonstrate that DualShield significantly improves both safety and task efficiency compared to leading methods from different planning paradigms under uncertainty.

## 详细分析

## DualShield 论文详细摘要

### 1. 研究背景和动机
自动驾驶的核心挑战在于处理与不可预测的人类驾驶员之间的复杂交互，这要求系统兼具**多模态探索能力**以做出果断决策，同时提供**严格的形式化安全保证**以应对最坏情况。现有方法存在局限：基于优化的规划器（如MPC）易陷入局部最优；基于采样的方法（如MPPI）探索能力有限且安全保证脆弱；基于生成模型（如扩散模型）的方法虽能进行全局探索，但通常难以显式强制执行系统动力学和硬安全约束，缺乏形式化安全保证。

### 2. 核心方法和技术创新
本文提出 **DualShield** 框架，其核心创新在于**双重利用汉密尔顿-雅可比可达性分析的价值函数**，将生成式规划与形式化安全统一在一个框架中：
- **主动安全引导**：将HJ价值函数作为安全感知的代价项，融入基于模型的扩散去噪过程的评分函数中，主动引导轨迹生成远离高风险区域。
- **反应式安全屏障**：将同一HJ价值函数重构为控制屏障-价值函数，并形式化为一个实时二次规划问题，对扩散规划器输出的名义控制进行最小化修改，确保执行时的安全。
- **统一框架**：该双重机制在滚动时域规划中协同工作，既保留了扩散模型强大的多模态探索能力，又为不确定甚至对抗性交互提供了有原则的安全保证。

### 3. 主要实验结果
在具有挑战性的无保护U型转弯场景中，与多种主流规划范式（模型基扩散MBD、非线性MPC、DualGuard-MPPI）进行对比实验，结果表明：
- **安全与效率俱佳**：DualShield实现了**100%的任务成功率**和**0%的碰撞率**，在所有保证安全的规划器中取得了**最短的平均任务完成时间**。
- **超越基线**：显著优于仅使用软约束的MBD（10%碰撞率）、陷入局部最优的NMPC（0%成功率）以及过于保守的DualGuard-MPPI（完成时间长、舒适性差）。
- **验证机制有效性**：可视化分析表明，安全引导有效驱使去噪过程中的轨迹分布收敛至安全、动态可行的区域；同时，框架展现出根据交互车辆意图（合作、无视、对抗）灵活生成不同策略（主动汇入、让行）的多模态行为能力。

### 4. 研究意义和价值
DualShield 成功解决了自动驾驶规划中**探索灵活性与形式化安全性之间的核心矛盾**。其理论价值在于提出了一种将HJ可达性分析深度融入生成式规划流程的新范式，实现了安全证书在规划层与控制层的双重利用。其实用价值在于为自动驾驶在高度不确定的交互场景中实现**既安全又高效**的决策提供了可验证的解决方案，推动了可信赖自主系统的实际部署。未来工作可探索通过强化学习在线近似HJ价值函数，以提升方法的通用性和计算效率。

## 问答对

### 问题 1

**Q**: 这篇论文的核心创新点是什么，他想解决什么问题，怎么解决的？

**A**: ## 论文核心分析

### **一、 论文旨在解决的核心问题**
论文旨在解决**自动驾驶交互规划中的一个核心矛盾**：如何同时实现**灵活的多模态探索**与**可证明的形式化安全保证**。

- **背景与挑战**：
    1.  **探索需求**：在复杂、不确定的交互场景（如无保护转弯）中，自动驾驶车辆需要像扩散模型这样的生成式模型进行**全局、多模态探索**，以避免陷入局部最优或“行为冻结”。
    2.  **安全需求**：车辆必须保证**绝对安全**，即使在面对其他交通参与者（Human Vehicles, HVs）最坏情况（对抗性）行为时。
    3.  **现有方法的不足**：
        - **基于优化的方法**（如MPC）：难以处理非凸、非可微问题，易陷入局部最优。
        - **基于采样的方法**（如MPPI）：探索能力有限，对初始化敏感，安全保证脆弱。
        - **基于扩散模型的方法**：缺乏对系统动力学和硬安全约束的显式强制执行，安全依赖软惩罚，缺乏形式化保证。
        - **基于安全屏障的方法**（如CBF）：在深度不确定的交互中设计困难且可能脆弱。

### **二、 核心创新点：DualShield框架**
论文的核心创新是提出了 **“DualShield”** 框架，其本质是**对汉密尔顿-雅可比可达性分析值函数的“双重利用”**，将生成式规划与形式化安全统一在一个可计算的框架内。

#### **创新点1：HJ值函数的双重角色机制**
这是论文最核心的技术创新。**同一个**预计算的HJ可达性值函数 `V(x_r)` 被用于两个层面：

1.  **主动引导（Proactive Guidance）**：
    - **作用**：在**扩散模型去噪（规划）过程**中，将值函数作为安全代价项引入目标函数（公式14）。
    - **效果**：引导扩散过程生成的候选轨迹**主动远离**由HJ值函数定义的“高风险区域”（即后向可达集 `B(x_r)`），使规划器在探索阶段就具备安全意识，生成**既高性能又倾向安全**的标称轨迹。

2.  **反应式屏蔽（Reactive Shielding）**：
    - **作用**：在执行阶段，将HJ值函数重构为**控制屏障-值函数（CBVF）**，并构建一个实时求解的二次规划问题（CBVF-QP，公式15）。
    - **效果**：对扩散规划器输出的每一时刻的标称控制指令 `u_nom` 进行**最小修改**，生成安全控制 `u_safe`，**严格保证**系统状态不进入故障集，即使面对HV的最坏行为。

#### **创新点2：统一的规划与控制架构**
- **方法融合**：创造性地将**模型预测扩散规划**与**基于HJ可达性的形式化安全分析**深度融合。
- **流程协同**：通过“主动引导”减少“反应式屏蔽”的干预频率和幅度，从而在保证安全的前提下，最大程度保留扩散模型的高性能探索能力。两者形成良性循环。

#### **创新点3：面向不确定交互的、可计算的安全屏蔽**
- **理论基础**：利用HJ可达性分析将EV与HV的交互建模为**零和微分博弈**，从而得到针对**最坏情况HV行为**的、紧致的最大控制不变集（安全集）。
- **工程实现**：将复杂的离线预计算值函数，转化为在线可快速查询的**CBVF-QP安全滤波器**，实现了理论严密性与实时计算可行性的平衡。

### **三、 解决方案的流程总结**
1.  **离线阶段**：预计算EV与HV（及静态障碍物）在相对动力学下的HJ值函数 `V(x_r)`，定义安全集 `S(x_r) = {x_r | V(x_r) >= 0}`。
2.  **在线规划（每个控制周期）**：
    a. **安全引导的扩散规划**：运行模型预测扩散算法。在去噪过程的评分函数估计中，融入包含HJ安全项 `J(y)`（公式14）的目标函数，生成一簇标称轨迹并选取最优标称控制序列 `u_nom`。
    b. **安全屏蔽执行**：取 `u_nom` 的第一个控制量 `u_nom(t)`，将其与当前状态 `x_r` 输入CBVF-QP（公式15）。该QP求解一个最接近 `u_nom(t)` 但满足CBVF安全约束的控制量 `u_safe(t)`，并立即执行。
3.  **滚动优化**：采用热启动策略，将上一周期的解加入噪声后作为下一周期扩散过程的初始值，提升计算效率。

### **四、 实际价值与效果**
- **性能提升**：在极具挑战的无保护U型转弯仿真中，DualShield实现了**100%的任务成功率**和**0%的碰撞率**，同时在所有保证安全的方法中**任务完成时间最短**。这验证了其能同时达成安全、高效和鲁棒性。
- **平衡艺术**：成功解决了开篇提出的“探索”与“安全”的矛盾。扩散模型负责“创造性”地提出多种策略（如激进汇入或保守让行），而HJ安全机制负责为所有策略“把关”，确保执行的绝对安全。
- **应用前景**：为在高度不确定、需与人类交互的复杂场景（城市道路、无信号灯路口等）中部署基于学习的规划器，提供了一条兼具**性能潜力**与**安全可信度**的技术路径。论文指出的未来方向（如在线学习HJ值函数）将进一步增强其泛化能力。


### 问题 2

**Q**: 请用一段话总结这篇论文，明确说明：论文试图解决的核心问题；提出的主要方法或框架；最终取得的主要效果或结论。要求语言简洁、信息密度高，不要复述摘要原文。

**A**: 这篇论文旨在解决自动驾驶中**多模态轨迹规划与可证明安全性难以兼顾**的核心矛盾。现有基于扩散模型的规划器虽能灵活探索多模态行为，但缺乏对车辆动力学和不确定交互下安全性的严格保证。为此，论文提出了 **DualShield** 框架，其核心创新在于**双重利用汉密尔顿-雅可比可达性分析的价值函数**：一方面，将其作为安全引导项融入扩散模型的反向去噪过程，主动将轨迹生成导向安全区域；另一方面，将其构建为控制屏障-价值函数，形成一个反应式安全滤波器，对最终执行的控制指令进行最小化修正以确保安全。该方法在具有对抗性交互的无保护U型转弯场景中进行验证，结果表明，DualShield在保持扩散模型强大探索能力的同时，实现了**零碰撞率与100%任务成功率**，在安全性和任务效率上均优于多种主流规划方法。


### 问题 3

**Q**: 这篇论文相对于已有工作有哪些明确的创新点？请逐条列出，并对每一条说明：相比以往方法改进或不同之处在哪里，以及该创新解决了什么具体问题或带来了什么优势。

**A**: ## 论文创新点分析

这篇论文提出的 **DualShield** 框架在自动驾驶的交互式运动规划领域具有明确的创新性。其核心在于**创造性地将汉密尔顿-雅可比（HJ）可达性分析的价值函数，以“双重”方式集成到基于扩散模型的规划与控制流程中**，从而统一了多模态探索能力与形式化安全保证。以下是其相对于已有工作的具体创新点：

---

### 1. **双重使用HJ价值函数：主动引导与被动屏蔽的统一框架**
   - **相比以往方法的改进/不同之处**：
     - **以往方法**：HJ可达性分析通常仅作为**被动的安全过滤器**（例如，在MPC中作为后处理步骤检查或修正轨迹），或者CBFs被单独用作约束。扩散模型则通常依赖数据驱动的学习或简单的距离惩罚来隐式处理安全，缺乏形式化保证。
     - **DualShield的创新**：**首次将同一个预计算的HJ价值函数 `V(x_r)` 在同一个框架内用于两个目的**：
       1.  **主动引导（Proactive Guidance）**：在扩散模型的**去噪（denoising）过程中**，将 `V(x_r)` 作为安全代价项引入目标函数（公式14），引导采样过程远离高风险区域。
       2.  **被动屏蔽（Reactive Shield）**：在执行时刻，将 `V(x_r)` 作为**控制障碍-价值函数（CBVF）**，构建一个实时二次规划（QP）问题（公式15），对规划出的名义控制量进行最小修改，确保形式化安全。
   - **解决的具体问题/带来的优势**：
     - **解决了“探索与安全”的根本矛盾**：传统方法（如纯优化或带安全层的采样）要么探索能力不足（易陷局部最优），要么安全保证脆弱（依赖软惩罚）。DualShield通过主动引导，让生成式模型在**规划阶段就“预见”并规避安全风险**，减少了后续屏蔽器的激进干预，从而在保持丰富多模态探索能力的同时，提供了可证明的安全保证。
     - **提升了安全性与效率的平衡**：被动屏蔽器仅在必要时进行最小幅度修正，避免了因过度保守（如DualGuard-MPPI）导致的性能下降（如任务完成时间变长、轨迹不流畅）。主动引导使生成的“名义轨迹”本身就更安全，降低了屏蔽器激活的频率和幅度。

### 2. **为多智能体交互设计了一个基于CBVF-QP的、可计算的实时安全屏蔽器**
   - **相比以往方法的改进/不同之处**：
     - **以往方法**：在扩散模型中集成安全约束，常见方法有：a) 在分数函数中嵌入CBF约束（设计复杂，对不确定性鲁棒性差）；b) 用QP后处理过滤轨迹（可能破坏轨迹的动态可行性或性能）。传统的CBF设计对于交互密集、不确定性高的场景（如对抗性人类车辆）往往显得脆弱。
     - **DualShield的创新**：利用**从HJ可达性分析导出的价值函数 `V(x_r)` 自然作为CBVF**。通过公式15构建的QP屏蔽器，**显式地考虑了最坏情况下人类车辆（HV）的控制输入**（通过 `min_{u_h}` 项），从而提供了针对有界不确定性和对抗性行为的**鲁棒安全保证**。
   - **解决的具体问题/带来的优势**：
     - **解决了在深度不确定性下的形式化安全难题**：该屏蔽器不依赖于对他人行为的准确预测（论文中规划时仅使用简单的恒定速度预测）。因为它基于HJ可达性，其安全保证覆盖了所有在控制集 `𝒰_h` 内的HV可能行为，包括最坏情况。
     - **提供了可计算、可实施的安全保证**：虽然HJ可达性离线计算耗时，但在线阶段只需查询预计算的价值函数及其梯度，并求解一个标准的QP，计算负担可控，实现了理论保证与实时性的结合。

### 3. **将模型预测控制（MPC）的滚动时域框架与安全引导的扩散模型生成进行高效结合**
   - **相比以往方法的改进/不同之处**：
     - **以往方法**：模型预测扩散（Model Predictive Diffusion）已有研究，但通常缺乏紧密集成的、具有形式化保证的安全机制。许多扩散规划器是开环或安全处理方式粗糙。
     - **DualShield的创新**：提出了一个包含**热启动（Warm-start）策略的完整滚动时域算法**（算法1）。将上一时刻优化得到的控制序列加入少量噪声后，作为下一次扩散去噪过程的初始值，**大幅减少了达到收敛所需的去噪步数**（`N_ws = 5` 远小于 `N_d = 100`）。
   - **解决的具体问题/带来的优势**：
     - **解决了扩散模型在线规划计算量大的问题**：热启动机制利用时间上的连续性，显著提升了在线规划的**计算效率**，使其更适合实时控制。
     - **实现了闭环、自适应的交互规划**：滚动时域执行结合双重安全机制，使系统能够持续感知环境变化（如其他车辆意图改变），并重新规划出既安全又高效的新轨迹，适应动态交互场景。

### 4. **在高度非凸、不确定的交互场景中验证了统一框架的优越性**
   - **相比以往方法的改进/不同之处**：
     - **以往方法**：对比实验通常局限于单一范式（如只比扩散模型，或只比优化器），或在较简单的场景中测试。
     - **DualShield的创新**：论文设计了**无保护U形转弯这一极具挑战性的场景**，并系统性地与**三大主流范式的代表方法**进行了对比：生成式模型（MBD）、优化方法（NMPC）、采样方法+安全过滤（DualGuard-MPPI）。同时，对HV设置了**合作、无视、对抗三种随机行为模式**，全面测试了算法在不确定性下的性能。
   - **解决的具体问题/带来的优势**：
     - **实证了所提框架的全面优势**：实验结果（表I）清晰表明，DualShield是**唯一能够同时达成100%任务成功率、0%碰撞率、且任务完成时间最短**的方法。这直接证明了其创新点1和2的有效性——即**统一框架在解决“安全-效率”权衡问题上超越了现有单一范式的方案**。
     - **展示了多模态行为生成能力**：如图5所示，框架能根据不同的交互情境（如两车都合作、或其中一辆对抗），**自主产生不同的策略**（激进汇入、谨慎让行），体现了扩散模型的多模态优势，且每一种行为都受到同一套形式化安全机制的保障。

---

**总结**：DualShield的核心创新在于**“一函两用”的架构设计思想**，即通过HJ价值函数这一桥梁，将**前端的生成式多模态探索**与**后端的形式化安全控制**无缝融合。它解决了自动驾驶规划中长期存在的“行为丰富性”与“安全可证明性”难以兼得的关键难题，并通过高效的算法实现和严格的实验验证，展示了其在复杂、不确定交互场景下的强大潜力。


### 问题 4

**Q**: 论文在实验或评估中最终实现了怎样的效果？请说明使用了哪些数据集和评价指标，与哪些基线方法进行了对比，以及在关键指标上的主要性能提升或结论。如果论文未给出明确的定量结果，也请说明原因。

**A**: ## 论文实验与评估效果分析

### 一、 实验场景与数据集
- **核心任务**：在**无保护交互式U型转弯**场景下进行验证。这是一个极具挑战性的任务，要求自车（EV）在非凸的轨迹空间中规划，同时处理来自对向来车（HV）的显著交互不确定性。
- **环境建模**：使用1:4缩放的仿真环境模拟真实交叉路口。场景中包含**2辆人类驾驶车辆（HV）**和**20个静态障碍物**。车道宽度为1.5米。
- **交互不确定性建模**：HV被编程为三种不同的交互模式，在每次试验开始时随机选择，以模拟真实世界的不确定性：
    1.  **合作型**：使用智能驾驶员模型（IDM）与前车保持安全距离。
    2.  **无视型**：忽略EV，保持预定的车道跟随速度。
    3.  **对抗型**：以最大加速度争夺路权，为EV制造最坏情况的威胁。
- **数据生成**：为确保统计显著性，进行了**100次仿真试验**。这些试验被结构化为10种随机生成的场景配置，每种配置运行10次。HV的初始速度从`[0.5, 2.0] m/s`中随机采样。

### 二、 评价指标
论文从**安全性、任务成功率、舒适性和计算效率**四个维度进行评估：

| 类别 | 指标 | 说明 |
| :--- | :--- | :--- |
| **安全性** | 碰撞率 `P_c` (%) | 发生碰撞的试验比例。 |
| | 最小距离 `l_{r,min}` (m) | EV与HV/静态障碍物之间的最小相对距离。`≤0`表示碰撞。 |
| **任务成功率** | 成功率 `P_s` (%) | 成功完成U型转弯并进入目标车道保持状态的试验比例。 |
| | 任务完成时间 `T_m` (s) | 从开始到首次达到稳定目标状态的时间。 |
| **舒适性** | 平均控制急动度 `j` (m/s³) | 控制指令（加速度变化率）的平滑度指标。 |
| **计算效率** | 平均单步计算时间 `T_c` (s) | 每个规划周期所需的平均计算时间。 |

### 三、 基线方法对比
论文选择了三个代表不同主流规划范式的基线方法进行对比：

1.  **Model-Based Diffusion (MBD)**：代表**生成式规划器**。使用扩散模型进行多模态轨迹生成，通过基于距离的软惩罚项处理安全性。
2.  **Nonlinear MPC (NMPC)**：代表**基于优化的规划器**。使用CasADi和IPOPT求解器处理非线性避障约束。
3.  **DualGuard-MPPI**：代表**基于采样的规划器（带有强安全考虑）**。使用与DualShield相同的HJ值函数作为拒绝采样器和安全过滤器的触发器。

### 四、 关键性能结果与结论
下表总结了DualShield与基线方法的定量对比结果：

| 方法 | 成功率 `P_s` ↑ | 碰撞率 `P_c` ↓ | 最小距离 `l_{r,min}` (m) ↑ | 完成时间 `T_m` (s) ↓ | 平均急动度 `j` (m/s³) ↓ | 计算时间 `T_c` (s) ↓ |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **MBD** | 90% | **10%** | 0.16 | 4.3 | 3.10 | **0.41** |
| **NMPC** | **0%** | 0% | 0.28 | – | **0.10** | 0.38 |
| **DualGuard-MPPI** | 80% | 0% | 0.24 | 7.39 | 6.40 | **0.24** |
| **DualShield (Ours)** | **100%** | **0%** | **0.26** | **4.7** | **2.78** | 0.78 |

**主要结论与性能提升：**

1.  **安全性与任务效率的完美平衡**：
    - **DualShield是唯一实现100%成功率且零碰撞的方法**。这证明了其“双重防护”机制（主动引导+反应式屏蔽）在不确定交互下提供**可证明的安全性**的有效性。
    - 在**所有安全的方法中（NMPC、DualGuard-MPPI）**，DualShield取得了**最短的平均任务完成时间（4.7秒）**。这表明HJ值函数的主动引导成功地将扩散过程导向了**既安全又高效的**区域，克服了纯反应式安全方法（如DualGuard-MPPI）导致的过度保守和犹豫（完成时间7.39秒）。

2.  **与各基线范式的对比分析**：
    - **vs. MBD (生成式)**：MBD虽然成功率较高（90%），但存在**10%的碰撞率**，凸显了仅依赖基于距离的软惩罚和简单预测（恒定速度）在对抗性交互下的根本性安全风险。DualShield通过HJ可达性分析，**即使使用相同的简单预测模型，也能保证安全**，因为它考虑了HV所有可能的未来动作（包括最坏情况）。
    - **vs. NMPC (优化式)**：NMPC**完全失败（0%成功率）**，突显了其在高度非凸规划场景中**容易陷入局部最优**的固有缺陷（例如，被困在初始车道无法启动转弯）。
    - **vs. DualGuard-MPPI (采样式+安全过滤)**：DualGuard-MPPI保证了安全（0%碰撞），但**牺牲了显著的性能**：完成时间更长，控制急动度更高。这揭示了**基于局部扰动的采样机制在探索能力上的瓶颈**。相比之下，DualShield利用扩散模型的**全局多模态探索能力**，在安全框架内找到了更优的轨迹。

3.  **其他优势展示**：
    - **多模态行为**：如图5所示，DualShield能够根据不同的HV交互模式（合作、对抗混合）灵活生成不同的策略（主动汇入、让行），实现了**离散策略推理与连续轨迹优化的统一**。
    - **引导有效性**：图2可视化显示，在去噪过程中，HJ安全引导项能有效将轨迹分布从高风险区域“拉回”，快速收敛到安全且动态可行的最优轨迹分布上。

4.  **当前局限**：
    - **计算成本**：DualShield的单步计算时间（0.78秒）高于所有基线。论文指出这主要源于采样和安全屏蔽过程中大量的值函数查询。作者建议可通过**GPU并行采样**和**批处理即时编译（JIT）** 的查询管道来优化。

**总结**：DualShield在极具挑战性的不确定交互驾驶场景中，实验证明其能够**同时实现形式化安全保证（零碰撞）和高任务效率（最短完成时间、更平滑控制）**，成功弥合了生成式规划的多模态探索能力与基于可达性分析的形式化安全保证之间的鸿沟，综合性能显著优于三大主流规划范式的代表性方法。


## 相关链接

- [arXiv 页面](https://arxiv.org/abs/2601.15729v1)
- [HTML 版本](https://arxiv.org/html/2601.15729v1)
